# Primary Backup Replication

What kind of failures replications are supposed to deal with?

## Failures
- Fail-stop faults: if something goes wrong, the computer just stops. 
Fan stops working. Network cable cut down. Power cut down.
These are covered.

Bugs in hardware and software are not covered. We cannot defend against
this.

Some can be turned into fail stop errors. Example are network error 
and disk block (something wrong with disk)

We are expected to handle only fail-stop faults.

Natural disasters can affect our replications.
It is better to spread replicas along different regions for availability.

## Types of Schemes and Strategies
- State Transfer Replication :
Primary sends copy of its entire state (RAM) to its secondary.

- Replicated State Machine: Just operations from external input or 
external events. Usually operations are smaller than a state.


## Replicated State Machine
- What is state?
- How closely synchronized Primary and Secondary has to be?
- Scheme for Switching over from Primary to Secondary. Cut-over.
- Anomalies during the Cut-over. Figure out a way to cope with it.
- New Replicas when a backup or Primary fails?

## What state to replicate?
Application specific replication. 


## VMware Fault Tolerance
VM - Virtual Machine

Virtual Machine - Stimulate multiple instance of different operating 
systems on a single machine

VMM - Virtual Machine Monitor is the software which simulates.

Let's say we have 2 machines, 1 Primary and 1 backup, running VM
and some guest OS and OS is running some application.
We also assume that there is some network connecting these two VMs.
Assuming that some clients are also connecting to these VMs.

The VMs have their own Disk Server that they talk to.

the clients sends packets to both VMs.
the primary and backup also sends packets back to clients with Lan.
the reply packets from backup are actually dropped by VMM.
The output is only generated by Primary.

the events between Primary and Backup are called LOG Entries CHANNEL.

When primary fails, backup sees that it stops getting logs entries on 
the channel.
When this happens, backup assumes that primary has died and it goes live.
The backup then acts as a Primary.
The vice versa happens when backup dies.


## Non deterministic events that may happen
There are some things that are not deterministic.

- Inputs : External input form clients. The only form of input and
output is packets from the network. The input is actually data inside
the packet. Sometimes, interrupts can happen. Now, these interrupts 
are supposed to be similar to both primary and secondary.
- Weird Instructions : Random number or time instructions, or UID
instructions.
- Multi Core Parallelism are not present in this system. Multi Core
system might cause different results depending on the core which 
executes the instruction. This is a big no no.

## Log Entry
- Instruction Number since the machine booted (Interrupt)
- Type
- data (packet data, result of weird instruction)

What if backup gets ahead of primary?
If Primary is getting down and it have interrupt in its logs, backup
might be executing the next instruction after the interrupt.
- We don't want to do that. Backup starts executing only after Primary
has executed an instruction in it and has a log entry for it.

## Output Rule
What happens when there is a failure at an awkard time?
Suppose, Primary sends the response back to client, 
and at the same time Primary dies before sending log entry of the 
increment instruction to backup.
Because of this, client will have +1 value, whereas backup will 
have stored the previous value and backup is now acking as a 
Primary. What are we supposed to do here?
- We use the output rule. Primary is not allowed to send 
response to client unless and until the backup sends the ACK
of receiving the Log entry.
- If client has seen a reply, we have a confirmation that backup 
has seen the reply.
- Since Primary has to wait for backup ack, this type of replication
scheme degrades the performance.

Test and Set server.